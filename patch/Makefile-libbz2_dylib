
# This Makefile builds a shared version of the library on OS X,
# libbz2.1.0.dylib, with installname libbz2.1.0.dylib,
# at least on modern Darwin (OS X 10.5 and above),
# with powerpc-apple-darwin9-gcc-4.0.1 (Apple Inc. build 5493) and
# Apple LLVM version 6.0 (clang-600.0.57) (based on LLVM 3.5svn)
# Please see the README file for some important info
# about building the library like this.

# ------------------------------------------------------------------
# This file is part of bzip2/libbzip2, a program and library for
# lossless, block-sorting data compression.
#
# bzip2/libbzip2 version 1.0.8 of 13 July 2019
# Copyright (C) 1996-2019 Julian Seward <jseward@acm.org>
#
# Please read the WARNING, DISCLAIMER and PATENTS sections in the
# README file.
#
# This program is released under the terms of the license contained
# in the file LICENSE.
# ------------------------------------------------------------------

SHELL=/bin/sh

# https://www.gnu.org/prep/standards/html_node/Makefile-Basics.html
.SUFFIXES:
.SUFFIXES: .c .o

# Where you want it installed when you do 'make install'
# https://www.gnu.org/prep/standards/html_node/Directory-Variables.html
PREFIX=/usr/local
LIBDIR=$(PREFIX)/lib
BINDIR=$(PREFIX)/bin
MANDIR=$(PREFIX)/man
INCLUDEDIR=$(PREFIX)/include

# To assist in cross-compiling. -stdlib=c++ may be desired for Xcode builds.
CC=
CPPFLAGS=
CFLAGS=-Wall -Winline -O2 -g
LDFLAGS=-Wl,-undefined -Wl,dynamic_lookup

# https://www.gnu.org/prep/standards/html_node/Command-Variables.html
# BZIP_CFLAGS follows ALL_CFLAGS in the example.
BZIP_CFLAGS=-D_FILE_OFFSET_BITS=64 -fPIC -fno-common $(CFLAGS)

OBJS= blocksort.o  \
      huffman.o    \
      crctable.o   \
      randtable.o  \
      compress.o   \
      decompress.o \
      bzlib.o

all: libbz2.1.0.8.dylib bzip2-shared

libbz2.1.0.8.dylib: $(OBJS)
	$(CC) -dynamiclib -Wl,-headerpad_max_install_names -Wl,-compatibility_version,1.0 -Wl,-current_version,1.0 -Wl,-install_name,libbz2.1.0.dylib $(CPPFLAGS) $(BZIP_CFLAGS) $(LDFLAGS) -o libbz2.1.0.8.dylib $(OBJS)
	rm -f libbz2.1.0.dylib libbz2.1.dylib libbz2.dylib
	ln -s libbz2.1.0.8.dylib libbz2.1.dylib
	ln -s libbz2.1.0.8.dylib libbz2.dylib

bzip2-shared: bzip2.o libbz2.1.0.8.dylib
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) bzip2.o -o bzip2-shared $(LDFLAGS) -L. -lbz2.1.0.8

install: bzip2-shared libbz2.1.0.8.dylib installdirs
	cp -f bzip2-shared $(BINDIR)/bzip2-shared
	chmod a+x $(BINDIR)/bzip2-shared
	cp -f bzlib.h $(INCLUDEDIR)
	chmod a+r $(INCLUDEDIR)/bzlib.h
	cp -f libbz2.1.0.8.dylib $(LIBDIR)/libbz2.1.0.8.dylib
	chmod a+x $(LIBDIR)/libbz2.1.0.8.dylib
	rm -f $(LIBDIR)/libbz2.1.0.dylib $(LIBDIR)/libbz2.1.dylib $(LIBDIR)/libbz2.dylib
	cd $(LIBDIR) && \
	ln -s libbz2.1.0.8.dylib libbz2.1.0.dylib && \
	ln -s libbz2.1.0.8.dylib libbz2.1.dylib && \
	ln -s libbz2.1.0.8.dylib libbz2.dylib
	install_name_tool -id $(LIBDIR)/libbz2.1.0.dylib $(LIBDIR)/libbz2.1.0.8.dylib
	install_name_tool -change libbz2.1.0.dylib $(LIBDIR)/libbz2.1.0.dylib $(BINDIR)/bzip2-shared

installdirs:
	if ( test ! -d $(BINDIR) ) ; then mkdir -p $(BINDIR) ; fi
	if ( test ! -d $(LIBDIR) ) ; then mkdir -p $(LIBDIR) ; fi
	if ( test ! -d $(LIBDIR)/pkgconfig ) ; then mkdir -p $(LIBDIR)/pkgconfig ; fi
	if ( test ! -d $(INCLUDEDIR) ) ; then mkdir -p $(INCLUDEDIR) ; fi

clean:
	rm -f $(OBJS) bzip2.o libbz2.1.0.8.dylib libbz2.1.0.dylib libbz2.1.dylib bzip2-shared

blocksort.o: blocksort.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
huffman.o: huffman.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
crctable.o: crctable.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
randtable.o: randtable.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
compress.o: compress.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
decompress.o: decompress.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
bzlib.o: bzlib.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
bzip2.o: bzip2.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
