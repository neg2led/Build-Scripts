
# This Makefile builds a shared version of the library,
# libbz2.so.1.0.8, with soname libbz2.so.1.0,
# at least on x86-Linux (RedHat 7.2),
# with gcc-2.96 20000731 (Red Hat Linux 7.1 2.96-98).
# Please see the README file for some important info
# about building the library like this.

# ------------------------------------------------------------------
# This file is part of bzip2/libbzip2, a program and library for
# lossless, block-sorting data compression.
#
# bzip2/libbzip2 version 1.0.8 of 13 July 2019
# Copyright (C) 1996-2019 Julian Seward <jseward@acm.org>
#
# Please read the WARNING, DISCLAIMER and PATENTS sections in the
# README file.
#
# This program is released under the terms of the license contained
# in the file LICENSE.
# ------------------------------------------------------------------

SHELL=/bin/sh

# https://www.gnu.org/prep/standards/html_node/Makefile-Basics.html
.SUFFIXES:
.SUFFIXES: .c .o

# Where you want it installed when you do 'make install'
# https://www.gnu.org/prep/standards/html_node/Directory-Variables.html
PREFIX=/usr/local
LIBDIR=$(PREFIX)/lib
BINDIR=$(PREFIX)/bin
MANDIR=$(PREFIX)/man
INCLUDEDIR=$(PREFIX)/include

# To assist in cross-compiling
CC=
CPPFLAGS=
CFLAGS=-Wall -Winline -O2 -g
LDFLAGS=

# https://www.gnu.org/prep/standards/html_node/Command-Variables.html
# BZIP_CFLAGS follows ALL_CFLAGS in the example.
BZIP_CFLAGS=-D_FILE_OFFSET_BITS=64 -fPIC $(CFLAGS)

OBJS= blocksort.o  \
      huffman.o    \
      crctable.o   \
      randtable.o  \
      compress.o   \
      decompress.o \
      bzlib.o

all: libbz2.so.1.0.8 bzip2-shared

libbz2.so.1.0.8: $(OBJS)
	$(CC) -shared -Wl,-soname -Wl,libbz2.so.1.0 $(CPPFLAGS) $(BZIP_CFLAGS) -o libbz2.so.1.0.8 $(LDFLAGS) $(OBJS)
	rm -f libbz2.so.1.0 libbz2.so.1 libbz2.so
	ln -s libbz2.so.1.0.8 libbz2.so.1
	ln -s libbz2.so.1.0.8 libbz2.so

bzip2-shared: bzip2.o libbz2.so.1.0.8
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) bzip2.o -o bzip2-shared $(LDFLAGS) libbz2.so.1.0.8

install: bzip2-shared libbz2.so.1.0.8 installdirs
	cp -f bzip2-shared $(BINDIR)/bzip2-shared
	chmod a+x $(BINDIR)/bzip2-shared
	cp -f bzlib.h $(INCLUDEDIR)
	chmod a+r $(INCLUDEDIR)/bzlib.h
	cp -f libbz2.so.1.0.8 $(LIBDIR)/libbz2.so.1.0.8
	chmod a+x $(LIBDIR)/libbz2.so.1.0.8
	rm -f $(LIBDIR)/libbz2.so.1.0 $(LIBDIR)/libbz2.so.1 $(LIBDIR)/libbz2.so
	cd $(LIBDIR) && \
	ln -s libbz2.so.1.0.8 libbz2.so.1.0 && \
	ln -s libbz2.so.1.0.8 libbz2.so.1 && \
	ln -s libbz2.so.1.0.8 libbz2.so

installdirs:
	if ( test ! -d $(BINDIR) ) ; then mkdir -p $(BINDIR) ; fi
	if ( test ! -d $(LIBDIR) ) ; then mkdir -p $(LIBDIR) ; fi
	if ( test ! -d $(LIBDIR)/pkgconfig ) ; then mkdir -p $(LIBDIR)/pkgconfig ; fi
	if ( test ! -d $(INCLUDEDIR) ) ; then mkdir -p $(INCLUDEDIR) ; fi

clean:
	rm -f $(OBJS) bzip2.o libbz2.so.1.0.8 libbz2.so.1.0 libbz2.so.1 libbz2.so bzip2-shared

blocksort.o: blocksort.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
huffman.o: huffman.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
crctable.o: crctable.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
randtable.o: randtable.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
compress.o: compress.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
decompress.o: decompress.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
bzlib.o: bzlib.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
bzip2.o: bzip2.c
	$(CC) $(CPPFLAGS) $(BZIP_CFLAGS) -c $< -o $@
